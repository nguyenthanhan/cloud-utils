# GeoIP blocking action
# Blocks IPs from specific countries: CN (China), RU (Russia), KP (North Korea)
[Definition]
actionstart =
actionstop =
actioncheck =

# Ban action: Check country and block if in blacklist
actionban = if command -v geoiplookup >/dev/null 2>&1; then
              COUNTRY=$(geoiplookup <ip> 2>/dev/null | grep -oP 'GeoIP Country Edition: \K[A-Z]{2}' | head -n1)
              if [ -z "$COUNTRY" ]; then
                COUNTRY=$(geoiplookup <ip> 2>/dev/null | awk -F': ' '{print $2}' | awk '{print $1}' | head -n1)
              fi
              if [ "$COUNTRY" = "CN" ] || [ "$COUNTRY" = "RU" ] || [ "$COUNTRY" = "KP" ]; then
                <iptables> -I f2b-<name> 1 -s <ip> -j <blocktype>
                echo "$(date '+%%Y-%%m-%%d %%H:%%M:%%S') Blocked <ip> from country: $COUNTRY" >> /var/log/fail2ban-geoip.log
              fi
            fi

# Unban action: Remove the block
actionunban = <iptables> -D f2b-<name> -s <ip> -j <blocktype> 2>/dev/null || true

# Default values
iptables = iptables
blocktype = DROP
name = geoip-block

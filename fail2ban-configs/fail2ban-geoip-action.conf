# GeoIP2 blocking action (using modern GeoLite2 database)
# Blocks IPs from specific countries: CN (China), RU (Russia), KP (North Korea)
[Definition]

# Create the iptables chain when jail starts
actionstart = <iptables> -N f2b-<name>
              <iptables> -A f2b-<name> -j RETURN
              <iptables> -I <chain> -p <protocol> --dport <port> -j f2b-<name>

# Remove the iptables chain when jail stops
actionstop = <iptables> -D <chain> -p <protocol> --dport <port> -j f2b-<name>
             <iptables> -F f2b-<name>
             <iptables> -X f2b-<name>

# Check if chain exists
actioncheck = <iptables> -n -L <chain> | grep -q 'f2b-<name>[ \t]'

# Ban action: Check country using GeoIP2 (mmdblookup) or fallback to GeoIP Legacy (geoiplookup)
actionban = COUNTRY=""
            if command -v mmdblookup >/dev/null 2>&1 && [ -f /usr/share/GeoIP/GeoLite2-Country.mmdb ]; then
              COUNTRY=$(mmdblookup --file /usr/share/GeoIP/GeoLite2-Country.mmdb --ip <ip> country iso_code 2>/dev/null | grep -oP '"\K[A-Z]{2}(?=")' | head -n1)
            elif command -v geoiplookup >/dev/null 2>&1; then
              COUNTRY=$(geoiplookup <ip> 2>/dev/null | grep -oP 'GeoIP Country Edition: \K[A-Z]{2}' | head -n1)
              if [ -z "$COUNTRY" ]; then
                COUNTRY=$(geoiplookup <ip> 2>/dev/null | awk -F': ' '{print $2}' | awk '{print $1}' | head -n1)
              fi
            fi
            if [ "$COUNTRY" = "CN" ] || [ "$COUNTRY" = "RU" ] || [ "$COUNTRY" = "KP" ]; then
              <iptables> -I f2b-<name> 1 -s <ip> -j <blocktype>
              echo "$(date '+%%Y-%%m-%%d %%H:%%M:%%S') Blocked <ip> from country: $COUNTRY" >> /var/log/fail2ban-geoip.log
            fi

# Unban action: Remove the block
actionunban = <iptables> -D f2b-<name> -s <ip> -j <blocktype> 2>/dev/null || true

# Default values
[Init]
iptables = iptables
blocktype = DROP
name = geoip-block
protocol = tcp
chain = INPUT
port = ssh

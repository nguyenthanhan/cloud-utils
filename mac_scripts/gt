#!/bin/zsh
# File: mac_scripts/git-tool
# Git tool with the following commands: gt fp, gt fm, gt fd, gt clean

# Check if we're in a git repository
_git_check_repo() {
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo "‚ùå Error: Not in a git repository"
        return 1
    fi
    return 0
}

# Function 1: Safe force push
git_safe_force_push() {
    if ! _git_check_repo; then
        return 1
    fi
    
    echo "--- üîÑ Force Push (safe)..."
    if git push --force-with-lease; then
        echo "--- ‚úÖ Force push successful"
        git fetch
        return 0
    else
        echo "--- ‚ùå Force push failed"
        return 1
    fi
}

# Function 2: Fetch main and develop (auto-detect which exist)
git_fetch() {
    if ! _git_check_repo; then
        return 1
    fi
    
    echo "--- ‚¨áÔ∏è Fetching branches ---"
    local fetched=false
    
    # Try main (or master as fallback)
    if git ls-remote --heads origin main > /dev/null 2>&1; then
        echo "--- Fetching main..."
        git fetch origin main:main && fetched=true
    elif git ls-remote --heads origin master > /dev/null 2>&1; then
        echo "--- Fetching master ‚Üí main..."
        git fetch origin master:main && fetched=true
    fi
    
    # Try develop
    if git ls-remote --heads origin develop > /dev/null 2>&1; then
        echo "--- Fetching develop..."
        git fetch origin develop:develop && fetched=true
    fi
    
    if [ "$fetched" = true ]; then
        _git_clean_gone
        return 0
    else
        echo "--- ‚ùå No main/master/develop branches found on remote"
        return 1
    fi
}

# Core cleanup function (internal)
_git_clean_gone() {
    echo "--- üßπ Fetching & Pruning ---"
    
    if ! git fetch --all --prune; then
        echo "--- ‚ö†Ô∏è Warning: Failed to fetch/prune"
        return 1
    fi
    
    # Find 'gone' branches BUT exclude current branch (line starts with *)
    branches=$(git branch -vv | grep ': gone]' | grep -v '^*' | awk '{print $1}')
    
    if [ -z "$branches" ]; then
        echo "--- ‚úÖ Clean! No branches to delete (or you are on that branch)."
        return 0
    fi
    
    echo "--- Found branches to delete: $branches"
    
    # Try soft delete first, then force if needed
    failed_branches=""
    for branch in $(echo "$branches"); do
        if git branch -d "$branch" 2>/dev/null; then
            echo "--- ‚úÖ Deleted: $branch"
        else
            failed_branches="$failed_branches $branch"
        fi
    done
    
    # If there are failed branches, offer to force delete
    if [ -n "$failed_branches" ]; then
        echo "--- ‚ö†Ô∏è Some branches couldn't be deleted (may not be merged):"
        echo "$failed_branches"
        echo "--- üí° Tip: Use 'gt clean --force' to force delete them"
    fi
}

# Cleanup command (can be called directly)
git_clean() {
    if ! _git_check_repo; then
        return 1
    fi
    
    local force_delete=false
    if [[ "$1" == "--force" ]] || [[ "$1" == "-f" ]]; then
        force_delete=true
    fi
    
    echo "--- üßπ Cleaning up gone branches ---"
    git fetch --all --prune
    
    branches=$(git branch -vv | grep ': gone]' | grep -v '^*' | awk '{print $1}')
    
    if [ -z "$branches" ]; then
        echo "--- ‚úÖ Clean! No branches to delete."
        return 0
    fi
    
    echo "--- Found branches to delete: $branches"
    
    for branch in $(echo "$branches"); do
        if [ "$force_delete" = true ]; then
            if git branch -D "$branch" 2>/dev/null; then
                echo "--- ‚úÖ Force deleted: $branch"
            else
                echo "--- ‚ùå Failed to delete: $branch"
            fi
        else
            if git branch -d "$branch" 2>/dev/null; then
                echo "--- ‚úÖ Deleted: $branch"
            else
                echo "--- ‚ö†Ô∏è Skipped (not merged): $branch (use --force to delete)"
            fi
        fi
    done
}

# Main function gt
gt() {
    if [[ $# -eq 0 ]]; then
        echo "Usage: gt <command> [options]"
        echo ""
        echo "Available commands:"
        echo "  fp     - Force push (safe)"
        echo "  fetch  - Fetch main & develop (auto-detect)"
        echo "  clean  - Clean up gone branches (use --force to force delete)"
        return 1
    fi
    
    COMMAND="$1"
    shift  # Remove first argument, pass rest to function
    
    # Map commands to functions
    case "$COMMAND" in
        fp)
            git_safe_force_push "$@"
            ;;
        fetch)
            git_fetch "$@"
            ;;
        clean)
            git_clean "$@"
            ;;
        *)
            echo "‚ùå Unknown command: $COMMAND"
            echo ""
            echo "Available commands:"
            echo "  fp     - Force push (safe)"
            echo "  fetch  - Fetch main & develop (auto-detect)"
            echo "  clean  - Clean up gone branches (use --force to force delete)"
            return 1
            ;;
    esac
}

# Auto-execute: Call function gt when running as script
if [[ "${(%):-%x}" == "${0}" ]]; then
    gt "$@"
fi


#!/bin/zsh
# File: mac_scripts/git-tool
# Git tool with the following commands: gt fp, gt fm, gt fd, gt clean

# Check if we're in a git repository
_git_check_repo() {
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo "‚ùå Error: Not in a git repository"
        return 1
    fi
    return 0
}

# Function 1: Safe force push
git_safe_force_push() {
    if ! _git_check_repo; then
        return 1
    fi
    
    echo "--- üîÑ Force Push (safe)..."
    if git push --force-with-lease; then
        echo "--- ‚úÖ Force push successful"
        git fetch
        return 0
    else
        echo "--- ‚ùå Force push failed"
        return 1
    fi
}

# Function 2: Update main branch
git_update_main() {
    if ! _git_check_repo; then
        return 1
    fi
    
    echo "--- ‚¨áÔ∏è Update local 'main' ---"
    
    # Check if remote branch exists
    if ! git ls-remote --heads origin main > /dev/null 2>&1; then
        echo "--- ‚ö†Ô∏è Warning: Remote branch 'main' not found"
        echo "--- Trying 'master' instead..."
        if git ls-remote --heads origin master > /dev/null 2>&1; then
            git fetch origin master:main
            _git_clean_gone
            return 0
        else
            echo "--- ‚ùå Error: Neither 'main' nor 'master' found on remote"
            return 1
        fi
    fi
    
    if git fetch origin main:main; then
        _git_clean_gone
        return 0
    else
        echo "--- ‚ùå Error: Failed to fetch main branch"
        return 1
    fi
}

# Function 3: Update develop branch
git_update_develop() {
    if ! _git_check_repo; then
        return 1
    fi
    
    echo "--- ‚¨áÔ∏è Update local 'develop' ---"
    
    # Check if remote branch exists
    if ! git ls-remote --heads origin develop > /dev/null 2>&1; then
        echo "--- ‚ùå Error: Remote branch 'develop' not found"
        return 1
    fi
    
    if git fetch origin develop:develop; then
        _git_clean_gone
        return 0
    else
        echo "--- ‚ùå Error: Failed to fetch develop branch"
        return 1
    fi
}

# Core cleanup function (internal)
_git_clean_gone() {
    echo "--- üßπ Fetching & Pruning ---"
    
    if ! git fetch --all --prune; then
        echo "--- ‚ö†Ô∏è Warning: Failed to fetch/prune"
        return 1
    fi
    
    # Find 'gone' branches BUT exclude current branch (line starts with *)
    branches=$(git branch -vv | grep ': gone]' | grep -v '^*' | awk '{print $1}')
    
    if [ -z "$branches" ]; then
        echo "--- ‚úÖ Clean! No branches to delete (or you are on that branch)."
        return 0
    fi
    
    echo "--- Found branches to delete: $branches"
    
    # Try soft delete first, then force if needed
    failed_branches=""
    for branch in $(echo "$branches"); do
        if git branch -d "$branch" 2>/dev/null; then
            echo "--- ‚úÖ Deleted: $branch"
        else
            failed_branches="$failed_branches $branch"
        fi
    done
    
    # If there are failed branches, offer to force delete
    if [ -n "$failed_branches" ]; then
        echo "--- ‚ö†Ô∏è Some branches couldn't be deleted (may not be merged):"
        echo "$failed_branches"
        echo "--- üí° Tip: Use 'gt clean --force' to force delete them"
    fi
}

# Cleanup command (can be called directly)
git_clean() {
    if ! _git_check_repo; then
        return 1
    fi
    
    local force_delete=false
    if [[ "$1" == "--force" ]] || [[ "$1" == "-f" ]]; then
        force_delete=true
    fi
    
    echo "--- üßπ Cleaning up gone branches ---"
    git fetch --all --prune
    
    branches=$(git branch -vv | grep ': gone]' | grep -v '^*' | awk '{print $1}')
    
    if [ -z "$branches" ]; then
        echo "--- ‚úÖ Clean! No branches to delete."
        return 0
    fi
    
    echo "--- Found branches to delete: $branches"
    
    for branch in $(echo "$branches"); do
        if [ "$force_delete" = true ]; then
            if git branch -D "$branch" 2>/dev/null; then
                echo "--- ‚úÖ Force deleted: $branch"
            else
                echo "--- ‚ùå Failed to delete: $branch"
            fi
        else
            if git branch -d "$branch" 2>/dev/null; then
                echo "--- ‚úÖ Deleted: $branch"
            else
                echo "--- ‚ö†Ô∏è Skipped (not merged): $branch (use --force to delete)"
            fi
        fi
    done
}

# Main function gt
gt() {
    if [[ $# -eq 0 ]]; then
        echo "Usage: gt <command> [options]"
        echo ""
        echo "Available commands:"
        echo "  fp     - Force push (safe)"
        echo "  fm     - Fetch and update main branch"
        echo "  fd     - Fetch and update develop branch"
        echo "  clean  - Clean up gone branches (use --force to force delete)"
        return 1
    fi
    
    COMMAND="$1"
    shift  # Remove first argument, pass rest to function
    
    # Map commands to functions
    case "$COMMAND" in
        fp)
            git_safe_force_push "$@"
            ;;
        fm)
            git_update_main "$@"
            ;;
        fd)
            git_update_develop "$@"
            ;;
        clean)
            git_clean "$@"
            ;;
        *)
            echo "‚ùå Unknown command: $COMMAND"
            echo ""
            echo "Available commands:"
            echo "  fp     - Force push (safe)"
            echo "  fm     - Fetch and update main branch"
            echo "  fd     - Fetch and update develop branch"
            echo "  clean  - Clean up gone branches (use --force to force delete)"
            return 1
            ;;
    esac
}

# Auto-execute: Call function gt when running as script
if [[ "${(%):-%x}" == "${0}" ]]; then
    gt "$@"
fi


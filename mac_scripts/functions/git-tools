# Check if we're in a git repository
_git_check_repo() {
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo "‚ùå Error: Not in a git repository"
        return 1
    fi
    return 0
}

# Function 1: Safe force push
git_safe_force_push() {
    if ! _git_check_repo; then
        return 1
    fi
    
    echo "--- üîÑ Force Push (safe)..."
    if git push --force-with-lease 2>/dev/null; then
        echo "--- ‚úÖ Force push successful"
        echo "--- ‚¨áÔ∏è Fetching..."
        if git fetch 2>/dev/null; then
            echo "--- ‚úÖ Fetch successful"
        else
            echo "--- ‚ùå Fetch failed"
        fi
        return 0
    else
        echo "--- ‚ùå Force push failed"
        return 1
    fi
}

# Helper function to sync with upstream
_sync_with_upstream() {
    # Check if upstream remote exists
    if ! git remote get-url upstream > /dev/null 2>&1; then
        return 1
    fi
    
    # Get current branch
    local current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
    
    # If on main, merge upstream changes
    if [ "$current_branch" = "main" ]; then
        # Check if upstream main branch exists
        if git ls-remote --heads upstream main > /dev/null 2>&1; then
            # Check for uncommitted changes
            if ! git diff --quiet || ! git diff --cached --quiet; then
                echo "--- ‚ö†Ô∏è You have uncommitted changes. Skipping upstream merge."
                echo "--- üí° Commit or stash your changes, then run 'gt fetch' again to merge upstream"
                return 0
            fi
            
            echo "--- üîÑ Merging upstream/main into main..."
            if git merge "upstream/main" --no-edit 2>/dev/null; then
                echo "--- ‚úÖ Merged upstream changes successfully"
                
                # Push the updated main to origin
                echo "--- üîÑ Pushing updated main to origin..."
                if git push origin main 2>/dev/null; then
                    echo "--- ‚úÖ Pushed updated main to origin"
                else
                    echo "--- ‚ö†Ô∏è Failed to push to origin, but local merge was successful"
                fi
            else
                echo "--- ‚ùå Merge failed - there might be conflicts"
                echo "--- üí° Resolve conflicts manually, then run 'git add .' and 'git commit'"
                return 1
            fi
        fi
    fi
    
    return 0
}

# Helper function to fetch and prune
_git_fetch_and_prune() {
    echo "--- ‚¨áÔ∏è Fetching from all remotes..."
    if git fetch --all --prune 2>/dev/null; then
        echo "--- ‚úÖ Fetch & prune successful"
        return 0
    else
        echo "--- ‚ùå Failed to fetch/prune"
        return 1
    fi
}

# Helper function to clean up gone branches
_cleanup_gone_branches() {
    local branches=$(git branch -vv | grep ': gone]' | grep -v '^*' | awk '{print $1}')
    
    if [ -z "$branches" ]; then
        return 0
    fi
    
    echo "--- üßπ Cleaning gone branches: $branches"
    for branch in $(echo "$branches"); do
        if git branch -d "$branch" 2>/dev/null; then
            echo "--- ‚úÖ Deleted: $branch"
        else
            echo "--- ‚ö†Ô∏è Skipped (not merged): $branch"
        fi
    done
}

# Helper function to get current branch
_get_current_branch() {
    git rev-parse --abbrev-ref HEAD 2>/dev/null
}

# Helper function to check if branch should auto-sync
_should_auto_sync() {
    local branch="$1"
    [ "$branch" = "main" ] || [ "$branch" = "develop" ]
}

# Helper function to sync current branch with origin
_sync_with_origin() {
    local branch="$1"
    
    echo "--- üîÑ Syncing $branch branch..."
    if git pull origin "$branch" 2>/dev/null; then
        echo "--- ‚úÖ Pulled from origin/$branch"
        return 0
    else
        echo "--- ‚ùå Pull failed - check for uncommitted changes"
        return 1
    fi
}

# Helper function to fetch main/develop branch without checkout
_fetch_main_develop() {
    for branch in main develop; do
        if git ls-remote --heads origin "$branch" > /dev/null 2>&1; then
            echo "--- ‚¨áÔ∏è Fetching origin/$branch without checkout..."
            if git fetch origin "$branch:$branch" 2>/dev/null; then
                echo "--- ‚úÖ Successfully updated local $branch from origin/$branch"
            else
                echo "--- ‚ö†Ô∏è Failed to fetch origin/$branch"
            fi
            return 0
        fi
    done
}

# Function 2: Fetch and sync repository
git_fetch() {
    if ! _git_check_repo; then
        return 1
    fi
    
    echo "--- ‚¨áÔ∏è Fetching and syncing repository ---"
    
    # Step 1: Fetch and prune
    if ! _git_fetch_and_prune; then
        return 1
    fi
    
    # Step 2: Fetch main/develop without checkout
    _fetch_main_develop
    
    # Step 3: Clean up gone branches
    _cleanup_gone_branches
    
    # Step 4: Get current branch and decide sync strategy
    local current_branch=$(_get_current_branch)
    
    if _should_auto_sync "$current_branch"; then
        # Step 5: Sync with origin
        if ! _sync_with_origin "$current_branch"; then
            return 1
        fi
        
        # Step 6: If on main, also sync with upstream
        if [ "$current_branch" = "main" ]; then
            _sync_with_upstream
        fi
    else
        echo "--- ‚ÑπÔ∏è On branch '$current_branch' - no auto-sync performed"
    fi
    
    return 0
}


# Main function gt
gt() {
    if [[ $# -eq 0 ]]; then
        echo "Usage: gt <command> [options]"
        echo ""
        echo "Available commands:"
        echo "  push   - Force push (safe)"
        echo "  fetch  - Fetch and sync repository"
        return 1
    fi
    
    COMMAND="$1"
    shift  # Remove first argument, pass rest to function
    
    # Map commands to functions
    case "$COMMAND" in
        push)
            git_safe_force_push "$@"
            ;;
        fetch)
            git_fetch "$@"
            ;;
        *)
            echo "‚ùå Unknown command: $COMMAND"
            echo ""
            echo "Available commands:"
            echo "  push   - Force push (safe)"
            echo "  fetch  - Fetch and sync repository"
            return 1
            ;;
    esac
}



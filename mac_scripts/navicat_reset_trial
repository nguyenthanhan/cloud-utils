#!/bin/bash
set -euo pipefail

# Author: NakamuraOS <https://github.com/nakamuraos>
# macOS version adapted
# Latest update: 12/18/2024
# Tested with Navicat 15.x, 16.x, and 17.x on macOS

BGRED="\033[1;97;41m"
ENDCOLOR="\033[0m"

echo -e "${BGRED}                                            ${ENDCOLOR}"
echo -e "${BGRED}  ┌──────────────────────────────────────┐  ${ENDCOLOR}"
echo -e "${BGRED}  │            !!! WARNING !!!           │  ${ENDCOLOR}"
echo -e "${BGRED}  ├──────────────────────────────────────┤  ${ENDCOLOR}"
echo -e "${BGRED}  │      ALL DATA can be destroyed.      │  ${ENDCOLOR}"
echo -e "${BGRED}  │   Always BACKUP before continuing.   │  ${ENDCOLOR}"
echo -e "${BGRED}  └──────────────────────────────────────┘  ${ENDCOLOR}"
echo -e "${BGRED}                                            ${ENDCOLOR}"

echo -e "\nReport issues:\n> https://gist.github.com/nakamuraos/717eb99b5e145ed11cd754ad3714b302\n"
echo -e "Reset trial \033[1mNavicat Premium\033[0m (macOS):"

if [[ ! "${1:-}" =~ ^--?[Yy]([eE][sS])?$ ]]; then
    read -p "Are you sure? (y/N) " -r
    echo
    if [[ ! $REPLY =~ ^[Yy]([eE][sS])?$ ]]; then
        echo "Aborted."
        exit 0
    fi
fi

echo "Starting reset..."
DATE=$(date '+%Y%m%d_%H%M%S')

NAVICAT_SUPPORT_DIR="$HOME/Library/Application Support/PremiumSoft CyberTech/Navicat CC/Navicat Premium"
NAVICAT_PLIST="$HOME/Library/Preferences/com.navicat.NavicatPremium.plist"
BACKUP_DIR="$HOME/Library/Application Support/PremiumSoft CyberTech/Navicat CC/backup"

# Backup
echo "=> Creating a backup..."
mkdir -p "$BACKUP_DIR"

if [[ -f "$NAVICAT_PLIST" ]]; then
    cp "$NAVICAT_PLIST" "$BACKUP_DIR/com.navicat.NavicatPremium.plist.$DATE"
    echo "Plist backup created at $BACKUP_DIR/com.navicat.NavicatPremium.plist.$DATE"
fi

if [[ -d "$NAVICAT_SUPPORT_DIR" ]]; then
    # Backup preferences if exists
    if [[ -f "$NAVICAT_SUPPORT_DIR/preferences.json" ]]; then
        cp "$NAVICAT_SUPPORT_DIR/preferences.json" "$BACKUP_DIR/preferences.json.$DATE"
        echo "Preferences backup created at $BACKUP_DIR/preferences.json.$DATE"
    fi
fi

# Reset
echo "=> Resetting..."

# Remove plist (trial info stored here)
if [[ -f "$NAVICAT_PLIST" ]]; then
    rm -f "$NAVICAT_PLIST"
    echo "Removed plist file"
fi

# Clear cached preferences
defaults delete com.navicat.NavicatPremium 2>/dev/null || true
echo "Cleared defaults cache"

# Remove trial-related data from preferences.json if exists
if [[ -f "$NAVICAT_SUPPORT_DIR/preferences.json" ]]; then
    sed -i '' -E 's/,?"([A-F0-9]+)":\{([^\}]+)},?//g' "$NAVICAT_SUPPORT_DIR/preferences.json"
    echo "Cleaned preferences.json"
fi

# Done
echo "Done. Please restart Navicat."

exit 0
